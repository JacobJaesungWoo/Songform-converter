<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¬ì–‘ ì†¡í¼ ë³€í™˜ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: 
            linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)),
            url('worship-bg.jpg');
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }
        
        body::before {
            content: 'ğŸµ';
            position: fixed;
            font-size: 120px;
            opacity: 0.03;
            top: 10%;
            left: 15%;
            animation: float 20s infinite ease-in-out;
        }
        
        body::after {
            content: 'ğŸ¶';
            position: fixed;
            font-size: 150px;
            opacity: 0.03;
            bottom: 15%;
            right: 10%;
            animation: float 25s infinite ease-in-out reverse;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(5deg); }
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            margin: 30px;
            padding: 60px 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
            display: block;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-zone.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-text {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: #666;
            font-size: 14px;
        }

        .result-section {
            padding: 30px;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .copy-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-btn.copied {
            background: #10b981;
        }

        .result-box {
            background: #f8f9ff;
            border: 1px solid #e0e7ff;
            border-radius: 12px;
            padding: 24px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            max-height: 500px;
            overflow-y: auto;
        }

        .reset-btn {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 12px 0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #667eea;
            color: white;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 30px;
            display: none;
        }

        .error.show {
            display: block;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸµ ì°¬ì–‘ ì†¡í¼ ë³€í™˜ê¸°</h1>
            <p>PDF/PPTX íŒŒì¼ì„ ë“œë˜ê·¸í•˜ë©´ ì¹´í†¡ ë©”ì‹œì§€ë¡œ ìë™ ë³€í™˜ë©ë‹ˆë‹¤</p>
        </div>

        <label for="fileInput" class="upload-zone" id="uploadZone">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
            <div class="upload-hint">PDF ë˜ëŠ” PPTX íŒŒì¼</div>
        </label>
        <input type="file" id="fileInput" accept=".pdf,.pptx">

        <div class="error" id="errorBox"></div>

        <div class="result-section" id="resultSection">
            <div class="result-header">
                <div class="result-title">ë³€í™˜ ê²°ê³¼</div>
                <button class="copy-btn" id="copyBtn">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
            </div>
            <div class="result-box" id="resultBox"></div>
            <button class="reset-btn" id="resetBtn">ë‹¤ì‹œ ë³€í™˜í•˜ê¸°</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const resultSection = document.getElementById('resultSection');
        const resultBox = document.getElementById('resultBox');
        const copyBtn = document.getElementById('copyBtn');
        const resetBtn = document.getElementById('resetBtn');
        const errorBox = document.getElementById('errorBox');

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragenter', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        uploadZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadZone.classList.remove('dragover');
            
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        // íŒŒì¼ ì²˜ë¦¬
        async function handleFile(file) {
            errorBox.classList.remove('show');
            
            const fileName = file.name.toLowerCase();
            
            try {
                let text = '';
                
                if (fileName.endsWith('.pdf')) {
                    text = await extractTextFromPDF(file);
                } else if (fileName.endsWith('.pptx')) {
                    text = await extractTextFromPPTX(file);
                } else {
                    showError('PDF ë˜ëŠ” PPTX íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤.');
                    return;
                }

                console.log('ì¶”ì¶œëœ í…ìŠ¤íŠ¸:', text);

                const songs = parseSongs(text);
                console.log('íŒŒì‹±ëœ ê³¡ë“¤:', songs);
                
                if (songs.length === 0) {
                    showError('ì†¡í¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const dateStr = extractDate(file.name);
                const message = formatKakaoMessage(songs, dateStr);
                
                showResult(message);
            } catch (error) {
                console.error('ì—ëŸ¬:', error);
                showError('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ
        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += pageText + '\n';
            }

            return fullText;
        }

        // PPTX í…ìŠ¤íŠ¸ ì¶”ì¶œ
        async function extractTextFromPPTX(file) {
            const arrayBuffer = await file.arrayBuffer();
            const zip = await JSZip.loadAsync(arrayBuffer);
            let fullText = '';

            const slideFiles = Object.keys(zip.files)
                .filter(name => name.startsWith('ppt/slides/slide') && name.endsWith('.xml'))
                .sort();

            for (const slideName of slideFiles) {
                const content = await zip.files[slideName].async('text');
                const matches = content.matchAll(/<a:t[^>]*>([^<]+)<\/a:t>/g);
                for (const match of matches) {
                    fullText += match[1] + ' ';
                }
                fullText += '\n';
            }

            return fullText;
        }

        // ì†¡í¼ íŒŒì‹±
        function parseSongs(text) {
            const songs = [];
            const seen = new Set();
            
            // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬
            const lines = text.split(/[\n\r]+/);
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;
                
                // ì´ ì¤„ì—ì„œ _í‚¤ íŒ¨í„´ ì°¾ê¸°
                const titleKeyMatch = trimmed.match(/([ê°€-í£\s]+?)_([A-G](?:#|b)?)/);
                if (!titleKeyMatch) continue;
                
                let title = titleKeyMatch[1].trim();
                const key = titleKeyMatch[2];
                const titleIndex = titleKeyMatch.index;
                
                // ì œëª©ì—ì„œ ì†¡í¼ ê´€ë ¨ ë‹¨ì–´ ì œê±° (ê¸°ë„, ê°„ì£¼ ë“±)
                title = title.replace(/^(ê¸°ë„|ê°„ì£¼)\s+/, '').trim();
                
                // ì œëª© ê³µë°± ì •ë¦¬ (ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ë¡œ)
                title = title.replace(/\s+/g, ' ').trim();
                
                // ì œëª© ë’·ë¶€ë¶„ì—ì„œ Key-up ì •ë³´ ì°¾ê¸°
                const afterTitle = trimmed.substring(titleIndex + titleKeyMatch[0].length);
                const keyUpMatch = afterTitle.match(/\(Key[-\s]?up[^)]*\)/i);
                const keyUpInfo = keyUpMatch ? keyUpMatch[0] : null;
                
                // ì œëª© ì•ë¶€ë¶„ì´ ì†¡í¼
                const form = trimmed.substring(0, titleIndex).trim();
                
                if (form) {
                    const songKey = `${title}_${key}`;
                    
                    // ì¤‘ë³µ ì²´í¬ - ê°™ì€ ê³¡ì´ë©´ ì²« ë²ˆì§¸ë§Œ ì‚¬ìš©
                    if (!seen.has(songKey)) {
                        songs.push({ title, key, form, keyUpInfo });
                        seen.add(songKey);
                    }
                }
            }
            
            console.log('ìµœì¢… íŒŒì‹±ëœ ê³¡ë“¤:', songs);
            return songs;
        }

        // ì†¡í¼ ë³€í™˜ ë° ì¤„ë°”ê¿ˆ
        function convertSongForm(form) {
            // Int/Out/Itr ë³€í™˜
            form = form.replace(/Int\s*\((\d+)\)/gi, "Intro$1'");
            form = form.replace(/Int'/gi, "Intro'");
            form = form.replace(/\bInt\b/gi, "Intro");
            
            form = form.replace(/Out\s*\((\d+)\)/gi, "Outro$1'");
            form = form.replace(/Out'/gi, "Outro'");
            form = form.replace(/\bOut\b/gi, "Outro");
            
            form = form.replace(/Itr\s*\((\d+)\)/gi, "Inter$1'");
            form = form.replace(/Itr'/gi, "Inter'");
            form = form.replace(/\bItr\b/gi, "Inter");
            
            // * â†’ x
            form = form.replace(/\*/g, 'x');
            
            // x ì•ë’¤ ê³µë°± ì œê±° (C x 2 â†’ Cx2)
            form = form.replace(/\s*x\s*/g, 'x');
            
            // ê´„í˜¸ ì•ˆì˜ í•˜ì´í”ˆ ë³´í˜¸
            const protectedForm = form.replace(/\([^)]+\)/g, (match) => {
                return match.replace(/-/g, 'Â§Â§DASHÂ§Â§');
            });
            
            // - ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
            const parts = protectedForm.split('-').map(p => p.trim()).filter(p => p);
            
            // ë³´í˜¸í•œ í•˜ì´í”ˆ ë³µì›
            const restoredParts = parts.map(p => p.replace(/Â§Â§DASHÂ§Â§/g, '-'));
            
            // ì„¹ì…˜ ì¶”ì¶œ í•¨ìˆ˜
            const getSectionBase = (p) => {
                const match = p.match(/^(\d*)([A-E])/);
                return match ? match[2] : null;
            };
            
            // ì¤„ë°”ê¿ˆ ê·œì¹™
            const lines = [];
            let currentLine = [];
            
            for (let i = 0; i < restoredParts.length; i++) {
                const part = restoredParts[i];
                
                // Intro/OutroëŠ” ë‹¨ë… ì¤„
                if (part.startsWith('Intro') || part.startsWith('Outro')) {
                    if (currentLine.length > 0) {
                        lines.push(currentLine.join(' - '));
                        currentLine = [];
                    }
                    lines.push(part);
                    continue;
                }
                
                // Inter, ê°„ì£¼ë„ ë‹¨ë… ì¤„
                if (part.startsWith('Inter') || part === 'ê°„ì£¼') {
                    if (currentLine.length > 0) {
                        lines.push(currentLine.join(' - '));
                        currentLine = [];
                    }
                    lines.push(part);
                    continue;
                }
                
                // í˜„ì¬ ë¼ì¸ì— ì¶”ê°€
                currentLine.push(part);
                
                // ê´„í˜¸ê°€ ìˆëŠ” íŒŒíŠ¸ë©´ ì¤„ë°”ê¿ˆ (íŠ¹ìˆ˜ ì²˜ë¦¬)
                const hasParen = part.includes('(') && part.includes(')');
                
                // í˜„ì¬ ì¤„ì˜ ì„¹ì…˜ë“¤
                const currentSections = currentLine.map(getSectionBase).filter(Boolean);
                
                // ì¤„ë°”ê¿ˆ íŒë‹¨
                let shouldBreak = false;
                
                // 1. ê°™ì€ ì¤„ì— ê°™ì€ ì„¹ì…˜ì´ 2ë²ˆ ë‚˜ì˜¤ë©´ ì¤„ë°”ê¿ˆ
                const sectionCounts = {};
                for (const sec of currentSections) {
                    sectionCounts[sec] = (sectionCounts[sec] || 0) + 1;
                    if (sectionCounts[sec] >= 2) {
                        shouldBreak = true;
                        break;
                    }
                }
                
                // 2. ê´„í˜¸ í¬í•¨ íŒŒíŠ¸ê°€ ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆ
                if (!shouldBreak && hasParen && currentLine.length >= 1) {
                    shouldBreak = true;
                }
                
                if (!shouldBreak && currentLine.length >= 2) {
                    // 2. ë‹¤ìŒ íŒŒíŠ¸ ë¯¸ë¦¬ë³´ê¸°
                    const nextPart = i + 1 < restoredParts.length ? restoredParts[i + 1] : null;
                    
                    if (currentLine.length >= 3) {
                        // 3ê°œ ëª¨ì˜€ìœ¼ë©´ ì¤„ë°”ê¿ˆ
                        shouldBreak = true;
                    } else if (currentLine.length === 2 && nextPart) {
                        const nextSection = getSectionBase(nextPart);
                        const currentLineSections = currentSections;
                        
                        // ë‹¤ìŒ ì„¹ì…˜ì´ ì´ë¯¸ í˜„ì¬ ì¤„ì— ìˆìœ¼ë©´ ì¤„ë°”ê¿ˆ (ë°˜ë³µ ì•„ë‹˜)
                        // ë‹¤ìŒ ì„¹ì…˜ì´ ìƒˆë¡œìš´ ì„¹ì…˜ì´ë©´ ê³„ì† (3ê°œê¹Œì§€ ëª¨ìœ¼ê¸°)
                        if (currentLineSections.includes(nextSection)) {
                            shouldBreak = true;
                        }
                    } else if (!nextPart) {
                        // ë§ˆì§€ë§‰ì´ë©´ ì¤„ë°”ê¿ˆ
                        shouldBreak = true;
                    }
                }
                
                if (shouldBreak) {
                    lines.push(currentLine.join(' - '));
                    currentLine = [];
                }
            }
            
            // ë‚¨ì€ ê²ƒ ì²˜ë¦¬
            if (currentLine.length > 0) {
                lines.push(currentLine.join(' - '));
            }
            
            return lines.join('\n');
        }

        // ë‚ ì§œ ì¶”ì¶œ
        function extractDate(filename) {
            const match = filename.match(/(\d{2})(\d{2})(\d{2})/);
            if (match) {
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);
                return `${month}ì›” ${day}ì¼`;
            }
            const now = new Date();
            return `${now.getMonth() + 1}ì›” ${now.getDate()}ì¼`;
        }

        // ì¹´í†¡ ë©”ì‹œì§€ í¬ë§·
        function formatKakaoMessage(songs, dateStr) {
            let message = `ğŸ”˜ ${dateStr} ì²­ë…„ì˜ˆë°° ì†¡í¼ğŸ”˜\n\n`;

            for (const song of songs) {
                const keyInfo = song.keyUpInfo ? ` ${song.keyUpInfo}` : '';
                message += `â˜‘ï¸ ${song.title} / ${song.key}í‚¤${keyInfo}\n`;
                message += convertSongForm(song.form);
                message += '\n\n';
            }

            // ì—°ì†ëœ ê³µë°±ì„ í•˜ë‚˜ë¡œ ì •ë¦¬
            message = message.replace(/ {2,}/g, ' ');

            return message;
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult(message) {
            resultBox.textContent = message;
            uploadZone.style.display = 'none';
            resultSection.classList.add('show');
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(msg) {
            errorBox.textContent = msg;
            errorBox.classList.add('show');
        }

        // ë³µì‚¬ ë²„íŠ¼
        copyBtn.addEventListener('click', async () => {
            try {
                // textareaë¥¼ ì„ì‹œë¡œ ë§Œë“¤ì–´ì„œ ë³µì‚¬í•˜ëŠ” ë°©ë²• (ë” í™•ì‹¤í•¨)
                const textarea = document.createElement('textarea');
                textarea.value = resultBox.textContent;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (success) {
                    copyBtn.textContent = 'âœ… ë³µì‚¬ì™„ë£Œ!';
                    copyBtn.classList.add('copied');
                    
                    setTimeout(() => {
                        copyBtn.textContent = 'ğŸ“‹ ë³µì‚¬í•˜ê¸°';
                        copyBtn.classList.remove('copied');
                    }, 2000);
                } else {
                    throw new Error('ë³µì‚¬ ì‹¤íŒ¨');
                }
            } catch (err) {
                // ì‹¤íŒ¨í•˜ë©´ í…ìŠ¤íŠ¸ ì„ íƒë§Œì´ë¼ë„
                const range = document.createRange();
                range.selectNode(resultBox);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                alert('ë³µì‚¬ ë²„íŠ¼ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ê°€ ì„ íƒë˜ì—ˆìœ¼ë‹ˆ Cmd+Cë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            }
        });

        // ë¦¬ì…‹ ë²„íŠ¼
        resetBtn.addEventListener('click', () => {
            uploadZone.style.display = 'block';
            resultSection.classList.remove('show');
            errorBox.classList.remove('show');
            fileInput.value = '';
        });
    </script>
</body>
</html>
